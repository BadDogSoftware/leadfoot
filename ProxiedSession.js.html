<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ProxiedSession.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ProxiedSession.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module leadfoot/ProxiedSession
 */

var lang = require('dojo/lang');
var Session = require('./Session');
var topic = require('dojo/topic');
var util = require('./util');

/* istanbul ignore next: client-side code */
function getCoverageData() {
	/*global __internCoverage:false */
	return typeof __internCoverage !== 'undefined' &amp;&amp; JSON.stringify(__internCoverage);
}

function publishCoverageData(sessionId, coverageData) {
	coverageData &amp;&amp; topic.publish('/coverage', sessionId, JSON.parse(coverageData));
}

/**
 * A ProxiedSession object represents a WebDriver session that interacts with the Intern instrumenting proxy. It
 * collects code instrumentation data from pages and converts local filesystem paths into URLs for use with
 * {@link module:leadfoot/Session#get}.
 *
 * @constructor module:leadfoot/ProxiedSession
 * @extends module:leadfoot/Session
 * @param {string} sessionId The ID of the session, as provided by the remote.
 * @param {module:leadfoot/Server} server The server that the session belongs to.
 * @param {Object} capabilities A map of bugs and features that the remote environment exposes.
 */
function ProxiedSession() {
	Session.apply(this, arguments);
}

ProxiedSession.prototype = Object.create(Session.prototype);
lang.mixin(ProxiedSession.prototype, /** @lends module:leadfoot/ProxiedSession# */ {
	constructor: ProxiedSession,

	/**
	 * The number of characters that need to be truncated from the front of file paths to get a working path-part
	 * for a URL.
	 *
	 * @type {number}
	 */
	proxyBasePathLength: 0,

	/**
	 * The base URL of the proxy server in use.
	 *
	 * @type {string}
	 */
	proxyUrl: '',

	_heartbeatIntervalHandle: null,

	/**
	 * Navigates the browser to a new URL like {@link module:leadfoot/Session#get}, but retrieves any code coverage
	 * data recorded by the browser prior to navigation.
	 *
	 * @param {string} url
	 * @returns {Promise.&lt;void>}
	 */
	get: function () {
		var self = this,
			args = Array.prototype.slice.call(arguments, 0);

		if (!/^[A-Za-z0-9+.-]+:/.test(args[0])) {
			args[0] = this.proxyUrl + args[0].slice(this.proxyBasePathLength);
		}

		return this.execute(getCoverageData)
			.then(function (coverageData) {
				return publishCoverageData(self.sessionId, coverageData);
			}).then(function () {
				return Session.prototype.get.apply(self, args);
			});
	},

	/**
	 * Quits the browser like {@link module:leadfoot/Session#quit}, but retrieves any code coverage data recorded
	 * by the browser prior to quitting.
	 *
	 * @returns {Promise.&lt;void>}
	 */
	quit: function () {
		var self = this;
		return this.setHeartbeatInterval(0)
			.then(function () {
				return self.execute(getCoverageData);
			})
			.then(function (coverageData) {
				return publishCoverageData(self.sessionId, coverageData);
			})
			.then(function () {
				return Session.prototype.quit.call(self);
			});
	},

	/**
	 * Sets up a timer to send no-op commands to the remote server on an interval to prevent long-running unit tests
	 * from causing the session to time out.
	 *
	 * @param {number} delay
	 * Amount of time to wait between heartbeats. Setting the delay to 0 will disable heartbeats.
	 *
	 * @returns {Promise.&lt;void>}
	 */
	setHeartbeatInterval: function (delay) {
		this._heartbeatIntervalHandle &amp;&amp; this._heartbeatIntervalHandle.remove();

		if (delay) {
			// A heartbeat command is sent immediately when the interval is set because it is unknown how long ago
			// the last command was sent and it simplifies the implementation by requiring only one call to
			// `setTimeout`
			var self = this;
			(function sendHeartbeat() {
				var timeoutId,
					cancelled = false,
					startTime = Date.now();

				self._heartbeatIntervalHandle = {
					remove: function () {
						cancelled = true;
						clearTimeout(timeoutId);
					}
				};

				self.getCurrentUrl().then(function () {
					if (!cancelled) {
						timeoutId = setTimeout(sendHeartbeat, delay - (Date.now() - startTime));
					}
				});
			})();
		}

		return util.createPromise(undefined);
	}
});

module.exports = ProxiedSession;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="Command.html">leadfoot/Command</a></li><li><a href="Element.html">leadfoot/Element</a></li><li><a href="keys.html">leadfoot/keys</a></li><li><a href="ProxiedSession.html">leadfoot/ProxiedSession</a></li><li><a href="Server.html">leadfoot/Server</a></li><li><a href="Session.html">leadfoot/Session</a></li><li><a href="util.html">leadfoot/util</a></li></ul><h3>Global</h3><ul><li><a href="global.html#deprecate">deprecate</a></li><li><a href="global.html#deprecateElementAndStandardSig">deprecateElementAndStandardSig</a></li><li><a href="global.html#deprecateElementSig">deprecateElementSig</a></li><li><a href="global.html#warn">warn</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha8</a> on Thu Jun 12 2014 16:02:28 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
