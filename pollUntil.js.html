<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: helpers/pollUntil.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: helpers/pollUntil.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module leadfoot/helpers/pollUntil
 */

var util = require('../lib/util');

/**
 * A {@link module:leadfoot/Command} helper that polls for a value within the client environment until the value exists
 * or a timeout is reached.
 *
 * @param {Function|string} poller
 * The poller function to execute on an interval. The function should return `null` or `undefined` if there is not a
 * result. If the poller function throws, polling will halt.
 *
 * @param {Array.&lt;any>=} args
 * An array of arguments to pass to the poller function when it is invoked.
 *
 * @param {number=} timeout
 * The maximum amount of time to wait for a successful result, in milliseconds. If not specified, the current
 * `executeAsync` maximum timeout for the session will be used.
 *
 * @param {number=} pollInterval
 * The amount of time to wait between calls to the poller function, in milliseconds. If not specified, defaults to 67ms.
 *
 * @returns {Promise.&lt;any>}
 * A promise that resolves to the value returned by the poller function on success and rejects on failure.
 *
 * @example
 * var Command = require('leadfoot/Command');
 * var pollUntil = require('leadfoot/helpers/pollUntil');
 *
 * new Command(session)
 *     .get('http://example.com')
 *     .then(pollUntil('return document.getElementById("a");', 1000))
 *     .then(function (elementA) {
 *         // element was found
 *     }, function (error) {
 *         // element was not found
 *     });
 *
 * @example
 * var Command = require('leadfoot/Command');
 * var pollUntil = require('leadfoot/helpers/pollUntil');
 *
 * new Command(session)
 *     .get('http://example.com')
 *     .then(pollUntil(function (value) {
 *         var element = document.getElementById('a');
 *         return element &amp;&amp; element.value === value ? true : null;
 *     }, [ 'foo' ], 1000))
 *     .then(function () {
 *         // value was set to 'foo'
 *     }, function (error) {
 *         // value was never set
 *     });
 */
module.exports = function (poller, args, timeout, pollInterval) {
	if (arguments.length === 3 &amp;&amp; typeof args === 'number') {
		pollInterval = timeout;
		timeout = args;
		args = [];
	}

	args = args || [];
	pollInterval = pollInterval || 67;

	return function () {
		var session = this.session;
		var originalTimeout;

		return session.getExecuteAsyncTimeout().then(function () {
			if (!isNaN(timeout)) {
				originalTimeout = arguments[0];
			}
			else {
				timeout = arguments[0];
			}

			return session.executeAsync(/* istanbul ignore next */ function (poller, args, timeout, pollInterval, done) {
				/* jshint evil:true */
				poller = new Function(poller);

				var endTime = Number(new Date()) + timeout;

				(function poll() {
					var result = poller.apply(this, args);

					/*jshint evil:true */
					if (result != null) {
						done(result);
					}
					else if (Number(new Date()) &lt; endTime) {
						setTimeout(poll, pollInterval);
					}
					else {
						done(null);
					}
				})();
			}, [ util.toExecuteString(poller), args, timeout, pollInterval ]).finally(function (result) {
				function finish() {
					if (result instanceof Error) {
						throw result;
					}
					else if (result === null) {
						throw new Error('Polling timed out with no result');
					}
					else {
						return result;
					}
				}

				if (!isNaN(originalTimeout)) {
					return session.setExecuteAsyncTimeout(originalTimeout).then(finish);
				}
				else {
					return finish();
				}
			});
		});
	};
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="Command.html">leadfoot/Command</a></li><li><a href="compat.html">leadfoot/compat</a></li><li><a href="Element.html">leadfoot/Element</a></li><li><a href="pollUntil.html">leadfoot/helpers/pollUntil</a></li><li><a href="keys.html">leadfoot/keys</a></li><li><a href="Server.html">leadfoot/Server</a></li><li><a href="Session.html">leadfoot/Session</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha8</a> on Wed Jun 25 2014 09:58:10 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
